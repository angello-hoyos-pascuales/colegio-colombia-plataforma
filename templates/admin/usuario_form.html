{% extends "base.html" %} {% block title %}{{ title }} - Administrador{%
endblock %} {% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      <i class="fas fa-user-plus text-primary me-2"></i>
      {{ title }}
    </h1>
    <div>
      <a
        href="{{ url_for('admin.usuarios') }}"
        class="btn btn-outline-secondary"
      >
        <i class="fas fa-arrow-left me-1"></i>Volver a Usuarios
      </a>
    </div>
  </div>

  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fas fa-user-edit me-2"></i>
            Información del Usuario
          </h5>
        </div>
        <div class="card-body">
          <form method="POST" novalidate>
            {{ form.hidden_tag() }}

            <!-- Información Personal -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-user me-2"></i>Información Personal
                </h6>
              </div>

              <div class="col-md-6 mb-3">
                {{ form.nombres.label(class="form-label") }} {{
                form.nombres(class="form-control" + (" is-invalid" if
                form.nombres.errors else "")) }} {% if form.nombres.errors %}
                <div class="invalid-feedback">
                  {% for error in form.nombres.errors %}
                  <div>{{ error }}</div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>

              <div class="col-md-6 mb-3">
                {{ form.apellidos.label(class="form-label") }} {{
                form.apellidos(class="form-control" + (" is-invalid" if
                form.apellidos.errors else "")) }} {% if form.apellidos.errors
                %}
                <div class="invalid-feedback">
                  {% for error in form.apellidos.errors %}
                  <div>{{ error }}</div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Documento de Identidad -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-id-card me-2"></i>Documento de Identidad
                </h6>
              </div>

              <div class="col-md-4 mb-3">
                {{ form.tipo_documento.label(class="form-label") }} {{
                form.tipo_documento(class="form-select" + (" is-invalid" if
                form.tipo_documento.errors else "")) }} {% if
                form.tipo_documento.errors %}
                <div class="invalid-feedback">
                  {% for error in form.tipo_documento.errors %}
                  <div>{{ error }}</div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>

              <div class="col-md-8 mb-3">
                {{ form.numero_documento.label(class="form-label") }} {{
                form.numero_documento(class="form-control" + (" is-invalid" if
                form.numero_documento.errors else "")) }} {% if
                form.numero_documento.errors %}
                <div class="invalid-feedback">
                  {% for error in form.numero_documento.errors %}
                  <div>{{ error }}</div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Información de Cuenta -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-envelope me-2"></i>Información de Cuenta
                </h6>
              </div>

              <div class="col-md-6 mb-3">
                {{ form.email.label(class="form-label") }} {{
                form.email(class="form-control" + (" is-invalid" if
                form.email.errors else "")) }} {% if form.email.errors %}
                <div class="invalid-feedback">
                  {% for error in form.email.errors %}
                  <div>{{ error }}</div>
                  {% endfor %}
                </div>
                {% endif %}
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  El email debe seguir el formato institucional
                </div>
              </div>

              <div class="col-md-6 mb-3">
                {{ form.role.label(class="form-label") }} {{
                form.role(class="form-select" + (" is-invalid" if
                form.role.errors else ""), onchange="mostrarCamposRol()") }} {%
                if form.role.errors %}
                <div class="invalid-feedback">
                  {% for error in form.role.errors %}
                  <div>{{ error }}</div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Contraseña (solo para nuevos usuarios) -->
            <div class="row mb-4" id="passwordSection">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-lock me-2"></i>Contraseña
                </h6>
              </div>

              <div class="col-md-6 mb-3">
                {{ form.password.label(class="form-label") }} {{
                form.password(class="form-control" + (" is-invalid" if
                form.password.errors else "")) }} {% if form.password.errors %}
                <div class="invalid-feedback">
                  {% for error in form.password.errors %}
                  <div>{{ error }}</div>
                  {% endfor %}
                </div>
                {% endif %}
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  Mínimo 6 caracteres
                </div>
              </div>

              <div class="col-md-6 mb-3">
                {{ form.password2.label(class="form-label") }} {{
                form.password2(class="form-control" + (" is-invalid" if
                form.password2.errors else "")) }} {% if form.password2.errors
                %}
                <div class="invalid-feedback">
                  {% for error in form.password2.errors %}
                  <div>{{ error }}</div>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </div>

            <!-- Campo Curso (solo para estudiantes) -->
            <div class="row mb-4" id="cursoSection" style="display: none">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-graduation-cap me-2"></i>Información
                  Académica
                </h6>
              </div>

              <div class="col-md-6 mb-3">
                {{ form.curso_id.label(class="form-label") }} {{
                form.curso_id(class="form-select" + (" is-invalid" if
                form.curso_id.errors else "")) }} {% if form.curso_id.errors %}
                <div class="invalid-feedback">
                  {% for error in form.curso_id.errors %}
                  <div>{{ error }}</div>
                  {% endfor %}
                </div>
                {% endif %}
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  Seleccione el curso al que pertenecerá el estudiante
                </div>
              </div>
            </div>

            <!-- Campo Materia Especialidad (solo para profesores) -->
            <div class="row mb-4" id="materiaSection" style="display: none">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-chalkboard-teacher me-2"></i>Especialidad
                  Docente
                </h6>
              </div>

              <div class="col-md-6 mb-3">
                {{ form.materia_especialidad.label(class="form-label") }} {{
                form.materia_especialidad(class="form-select" + (" is-invalid"
                if form.materia_especialidad.errors else "")) }} {% if
                form.materia_especialidad.errors %}
                <div class="invalid-feedback">
                  {% for error in form.materia_especialidad.errors %}
                  <div>{{ error }}</div>
                  {% endfor %}
                </div>
                {% endif %}
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  Seleccione la materia principal que enseñará el profesor
                </div>
              </div>
            </div>

            <!-- Estado del Usuario -->
            <div class="row mb-4">
              <div class="col-12">
                <h6 class="text-primary mb-3">
                  <i class="fas fa-toggle-on me-2"></i>Estado
                </h6>
              </div>

              <div class="col-md-6">
                <div class="form-check form-switch">
                  {{ form.activo(class="form-check-input") }} {{
                  form.activo.label(class="form-check-label") }}
                </div>
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  Los usuarios inactivos no pueden acceder al sistema
                </div>
              </div>
            </div>

            <!-- Botones de Acción -->
            <div class="d-flex justify-content-end gap-2">
              <a
                href="{{ url_for('admin.usuarios') }}"
                class="btn btn-outline-secondary"
              >
                <i class="fas fa-times me-1"></i>Cancelar
              </a>
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save me-1"></i>{{ title }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Función para mostrar/ocultar campos según el rol
  function mostrarCamposRol() {
    const rolSelect = document.querySelector('[name="role"]');
    const cursoSection = document.getElementById("cursoSection");
    const materiaSection = document.getElementById("materiaSection");

    // Ocultar todas las secciones primero
    cursoSection.style.display = "none";
    materiaSection.style.display = "none";

    // Mostrar la sección correspondiente según el rol
    if (rolSelect.value === "estudiante") {
      cursoSection.style.display = "block";
    } else if (rolSelect.value === "profesor") {
      materiaSection.style.display = "block";
    }
  }

  // Ejecutar al cargar la página
  document.addEventListener("DOMContentLoaded", function () {
    mostrarCamposRol();

    // Auto-generar email basado en nombre, apellido y rol
    const nombreInput = document.querySelector('[name="nombres"]');
    const apellidoInput = document.querySelector('[name="apellidos"]');
    const rolSelect = document.querySelector('[name="role"]');
    const emailInput = document.querySelector('[name="email"]');

    function generarEmail() {
      const nombre = nombreInput.value.trim().toLowerCase();
      const apellido = apellidoInput.value.trim().toLowerCase();
      const rol = rolSelect.value;

      if (nombre && apellido && rol) {
        let email = "";
        const primerNombre = nombre.split(" ")[0];
        const primerApellido = apellido.split(" ")[0];

        if (rol === "estudiante") {
          email = `${primerNombre}.${primerApellido}@estudiante.colegiocolombia.edu.co`;
        } else if (rol === "profesor") {
          email = `${primerNombre}.${primerApellido}@colegiocolombia.edu.co`;
        } else if (rol === "admin") {
          email = `${primerNombre}.${primerApellido}@admin.colegiocolombia.edu.co`;
        }

        emailInput.value = email;
      }
    }

    nombreInput.addEventListener("blur", generarEmail);
    apellidoInput.addEventListener("blur", generarEmail);
    rolSelect.addEventListener("change", function () {
      mostrarCamposRol();
      generarEmail();
    });
  });
</script>
{% endblock %}
